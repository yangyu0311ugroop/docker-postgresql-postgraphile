# Docker-PostgreSQL-PostGraphile

The following guide describes how to run a network of Docker containers on a local machine, including one container for a PostgreSQL database and one container for PostGraphile. A the end of this guide, you will have a GraphQL API exposing data from a PostgreSQL database, both running locally on your machine in separate Docker containers.

![Architecture](https://github.com/alexisrolland/docker-postgresql-postgraphile/blob/master/doc/architecture.png)

You need this DevEnv Branch to Work with it
[DevEnv-GraphQl](https://github.com/ugr00p/UGroopDevEnv/tree/posgraphql)

# Requirements
Minimum Requirements: Postgres 11, as it needs custom plugins.
- Clean Database 

    - You can delete the data folder sits under your db project, it shall create all the database for you.
- If you want to keep the database, you need to dump your database, then restore it later by using the command below. 
    - psql -h 127.0.0.1 -U db_admin -d postgres -f your_dump.sql


## Hot to Run Graphql Service
If you use the PostGraphql DevEnv, you can just simply run `./service_start.sh`, especailly those who has slow computer, as it waits 1 mins for RabbitMQ and DB before it starts other services.

### Parameters description

<table>
    <tr>
        <th>Parameter</th><th>Description</th>
    </tr>
    <tr>
        <td><b>DB_SERVER</b></td>
        <td>Your DB server domain name</td>
    </tr>
    <tr>
         <td><b>DB_PORT</b></td>
         <td>Postgres Port, default: 5432 </td>
    </tr>
    <tr>
        <td><b>DATABASE_URL</b></td>
        <td>Postgraphile URL Format to connect the database<br/> postgres://db_admin:password@db:5432/yourDbName</td>
    </tr>
    <tr>
        <td><b>GRAPHQL_PORT</b></td>
        <td>In Development environment, you can use a Graphql Playground to test your graphql.<br/> So this is the port it will run that Graphql User Interface.</td>
    </tr>
</table>

## PostGraphile Dockerfile

For Development, it used node:12 as the base, and it will run the command below. <br/>
It shall give you enough to start your bare minimum feature of your Graphql. <br/>
More Information you can find [here](https://www.graphile.org/postgraphile/usage-cli/)

```
START_CMD="postgraphile
  -n 0.0.0.0
  --watch
  --dynamic-json
  --no-setof-functions-contain-nulls
  --no-ignore-rbac
  --no-ignore-indexes
  --show-error-stack=json
  --extended-errors hint,detail,errcode
  --append-plugins @graphile-contrib/pg-simplify-inflector,postgraphile-plugin-connection-filter
  --export-schema-graphql ./schema/coordinate.schema.graphql
  --graphiql "/graphiql"
  --enhance-graphiql
  --allow-explain
  --enable-query-batching
  --legacy-relations omit
  --connection $DATABASE_URL
  --port $GRAPHQL_PORT
  --schema public
  "
```

For Production, some development features will be disabled, for instance, no export schema, no playground UI. 
```
CMD postgraphile \
      -n 0.0.0.0 \
      --retry-on-init-fail \
      --dynamic-json \
      --no-setof-functions-contain-nulls \
      --no-ignore-rbac \
      --no-ignore-indexes \
      --extended-errors errcode \
      --append-plugins @graphile-contrib/pg-simplify-inflector,postgraphile-plugin-connection-filter \
      --enable-query-batching \
      --disable-query-log  \
      --legacy-relations omit \
      --connection $DATABASE_URL \
      --port $GRAPHQL_PORT \
      --schema public
```
Folder structure.
```
/
├─ EventGraphQl/
|  ├─ custom-plugin/
|  ├─ schema/
|  |  ├─ event.schema.graphql
|  └─ Dockerfile
|  └─ Dockerfile.prod
├─ .startup.sh // Development only, if you want to tweak your graphql feature, go there.
└─ .wait-for-it.sh
```

# Add Custom Plugin

## makeWrapResolversPlugin

This section is optional but describes how to wrap a resolver generated by PostGraphile in order to customize it. In the folder `graphql`, create a new subfolder named `custom-plugin`. In this folder create a new file `package.json` with the following content (you can update it to your convenience).

```json
{
    "name": "custom-plugin",
    "version": "0.0.1",
    "description": "Custom plugin example for PostGraphile.",
    "main": "index.js",
    "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1"
    },
    "author": "Alexis ROLLAND",
    "license": "Apache-2.0",
    "dependencies": {
        "graphile-utils": "^4.5.6",
        "postgraphile": "^4.5.5"
    }
}
```

In the same folder `custom-plugin`, create a new file `index.js` with the following content.

```js
const { makeWrapResolversPlugin } = require("graphile-utils");

// Create custom wrapper for resolver createUser
const createUserResolverWrapper = () => {
    return async (resolve, source, args, context, resolveInfo) => {
        // You can do something before the resolver executes
        console.info("Hello world!");
        console.info(args);

        // Let resolver execute against database
        const result = await resolve();

        // You can do something after the resolver executes
        console.info("Hello again!");
        console.info(result);

        return result;
    };
};

// Register custom resolvers
module.exports = makeWrapResolversPlugin({
    Mutation: {
        createUser: createUserResolverWrapper()
    }
});
```

# Dockerfile

In each project folder, it has `Dockerfile` and `Dockerfile.prod` so that it looks like the one below.

```dockerfile
FROM node:alpine
LABEL description="Instant high-performance GraphQL API for your PostgreSQL database https://github.com/graphile/postgraphile"
WORKDIR /home/coordinategraphql
# Install PostGraphile and PostGraphile connection filter plugin
RUN npm install -g postgraphile@4.9.0
RUN npm install -g @graphile-contrib/pg-simplify-inflector@6.0.0
RUN npm install -g postgraphile-plugin-connection-filter@2.0.0

# Install custom plugin
# COPY ./custom-plugin /tmp/custom-plugin
# RUN cd /tmp/custom-plugin && npm pack
# RUN npm install -g /tmp/custom-plugin/custom-plugin-0.0.1.tgz
# RUN rm -rf /tmp/custom-plugin
ADD ./wait-for-it.sh .
RUN ls
RUN chmod 755 wait-for-it.sh
EXPOSE 4040
CMD postgraphile \
      -n 0.0.0.0 \
      --retry-on-init-fail \
      --dynamic-json \
      --no-setof-functions-contain-nulls \
      --no-ignore-rbac \
      --no-ignore-indexes \
      --extended-errors errcode \
      --append-plugins @graphile-contrib/pg-simplify-inflector,postgraphile-plugin-connection-filter \
      --enable-query-batching \
      --disable-query-log  \
      --legacy-relations omit \
      --connection $DATABASE_URL \
      --port $GRAPHQL_PORT \
      --schema public
```

# Queries Examples

## Queries

Example of query to get all posts and their author.

```
query {
  allPosts {
    nodes {
      id
      title
      body
      userByAuthorId {
        username
      }
    }
  }
}
```

![Query](https://github.com/alexisrolland/docker-postgresql-postgraphile/blob/master/doc/query.png)

## Mutations

Please do no use Mutation in this project.
